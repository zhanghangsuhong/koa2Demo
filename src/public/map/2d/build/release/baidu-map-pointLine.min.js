!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.PointLine=e()}(this,function(){"use strict";function t(t){this.options=t||{},this.paneName=this.options.paneName||"labelPane",this.zIndex=this.options.zIndex||0,this._map=t.map,this._lastDrawTime=null,this.show()}t.prototype=new BMap.Overlay,t.prototype.initialize=function(t){this._map=t;var e=this.canvas=document.createElement("canvas"),i=this.ctx=this.canvas.getContext("2d");e.style.cssText="position:absolute;left:0;top:0;z-index:"+this.zIndex+";",this.adjustSize(),this.adjustRatio(i),t.getPanes()[this.paneName].appendChild(e);var n=this;return t.addEventListener("resize",function(){n.adjustSize(),n._draw()}),this.canvas},t.prototype.adjustSize=function(){var t=this._map.getSize(),e=this.canvas;e.width=t.width,e.height=t.height,e.style.width=e.width+"px",e.style.height=e.height+"px"},t.prototype.adjustRatio=function(t){var e=t.backingStorePixelRatio||t.webkitBackingStorePixelRatio||t.mozBackingStorePixelRatio||t.msBackingStorePixelRatio||t.oBackingStorePixelRatio||t.backingStorePixelRatio||1,i=(window.devicePixelRatio||1)/e,n=t.canvas.width,a=t.canvas.height;t.canvas.width=n*i,t.canvas.height=a*i,t.canvas.style.width=n+"px",t.canvas.style.height=a+"px",t.scale(i,i)},t.prototype.draw=function(){var t=this;clearTimeout(t.timeoutID),t.timeoutID=setTimeout(function(){t._draw()},15)},t.prototype._draw=function(){var t=this._map,e=t.getSize(),i=t.getCenter();if(i){var n=t.pointToOverlayPixel(i);this.canvas.style.left=n.x-e.width/2+"px",this.canvas.style.top=n.y-e.height/2+"px",this.dispatchEvent("draw"),this.options.update&&this.options.update.call(this)}},t.prototype.getContainer=function(){return this.canvas},t.prototype.show=function(){this.canvas||this._map.addOverlay(this),this.canvas.style.display="block"},t.prototype.hide=function(){this.canvas.style.display="none"},t.prototype.setZIndex=function(t){this.canvas.style.zIndex=t},t.prototype.getZIndex=function(){return this.zIndex};var e={merge:function(t,e){Object.keys(t).forEach(function(i){e[i]=t[i]})},getDistance:function(t,e){return Math.sqrt((t[0]-e[0])*(t[0]-e[0])+(t[1]-e[1])*(t[1]-e[1]))},containStroke:function(t,e,i,n,a,o,s){if(0===a)return!1;var h=a,r=0,p=t;if(s>e+h&&s>n+h||s<e-h&&s<n-h||o>t+h&&o>i+h||o<t-h&&o<i-h)return!1;if(t===i)return Math.abs(o-t)<=h/2;r=(e-n)/(t-i),p=(t*n-i*e)/(t-i);var c=r*o-s+p;return c*c/(r*r+1)<=h/2*h/2}},i=function(e,i){function n(t){this.name=t.name,this.path=t.path}var a=this;a.map=e,a.lines=[],a.pixelList=[];var o={lineWidth:1,lineStyle:"#F9815C"},s=null,h=e.getSize().width,r=e.getSize().height;n.prototype.getPointList=function(){var t=[],i=this.path;return i&&i.length>0&&i.forEach(function(i){t.push({name:i.name,pixel:e.pointToPixel(i.location)})}),t},n.prototype.draw=function(t){var e=this.pixelList||this.getPointList();t.save(),t.beginPath(),t.lineWidth=o.lineWidth,t.strokeStyle=o.lineStyle,t.moveTo(e[0].pixel.x,e[0].pixel.y);for(var i=0,n=e.length;i<n;i++)t.lineTo(e[i].pixel.x,e[i].pixel.y);t.stroke(),t.closePath(),t.restore()};var p=function(){var t=s.canvas.getContext("2d");t&&(c(),t.clearRect(0,0,h,r),a.pixelList=[],a.lines.forEach(function(e){a.pixelList.push({name:e.name,data:e.getPointList()}),e.draw(t)}))},c=function(){if(!(a.lines&&a.lines.length>0)){o.data.forEach(function(t,e){var i=new n({name:t.name,path:[]});t.data.forEach(function(t,e){i.path.push({name:t.name,location:new BMap.Point(t.Longitude,t.Latitude)})}),a.lines.push(i)})}};a.init(i,o),s=new t({map:e,update:p}),this.clickEvent=this.clickEvent.bind(this),this.bindEvent()};return i.prototype.init=function(t,i){e.merge(t,i),this.options=i},i.prototype.bindEvent=function(t){var e=this.map;this.options.methods&&(this.options.methods.click&&(e.setDefaultCursor("default"),e.addEventListener("click",this.clickEvent)),this.options.methods.mousemove&&(e.setDefaultCursor("default"),e.addEventListener("mousemove",this.clickEvent)))},i.prototype.clickEvent=function(t){var i=this,n=i.pixelList;n.length>0&&n.forEach(function(n,a){for(var o=0;o<n.data.length;o++){var s=n.data[o].pixel;if(void 0==n.data[o+1])return;var h=n.data[o+1].pixel,r=t.pixel;if(e.containStroke(s.x,s.y,h.x,h.y,i.options.lineWidth,r.x,r.y))return void i.options.methods.click(t,n.name)}})},i});